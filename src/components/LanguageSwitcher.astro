---
import { languages, type Lang } from '../i18n/translations';

interface Props {
  currentLang: Lang;
}

const { currentLang } = Astro.props;
const currentPath = Astro.url.pathname;

// Remove language prefix from path
function getPathWithoutLang(path: string): string {
  const segments = path.split('/').filter(Boolean);
  if (segments[0] in languages) {
    segments.shift();
  }
  return '/' + segments.join('/');
}

const basePath = getPathWithoutLang(currentPath);

function getLocalizedPath(lang: Lang): string {
  if (lang === 'en') return basePath || '/';
  return `/${lang}${basePath}`;
}
---

<div class="relative" id="lang-switcher">
  <button 
    class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors text-white text-sm"
    aria-label="Select language"
    id="lang-btn"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
    </svg>
    <span>{languages[currentLang]}</span>
    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>
  
  <div class="hidden absolute top-full right-0 mt-2 bg-white rounded-xl shadow-xl border border-stone-200 overflow-hidden min-w-[160px] z-50" id="lang-dropdown">
    {Object.entries(languages).map(([code, name]) => (
      <a 
        href={getLocalizedPath(code as Lang)}
        class={`block px-4 py-3 text-sm hover:bg-nile-50 transition-colors ${currentLang === code ? 'bg-nile-100 text-nile-700 font-medium' : 'text-stone-700'}`}
        data-lang={code}
      >
        <span class="flex items-center gap-2">
          {code === 'en' && 'ðŸ‡¬ðŸ‡§'}
          {code === 'es' && 'ðŸ‡ªðŸ‡¸'}
          {code === 'ar' && 'ðŸ‡ªðŸ‡¬'}
          {name}
        </span>
      </a>
    ))}
  </div>
</div>

<script>
  const btn = document.getElementById('lang-btn');
  const dropdown = document.getElementById('lang-dropdown');
  
  btn?.addEventListener('click', () => {
    dropdown?.classList.toggle('hidden');
  });
  
  // Close on click outside
  document.addEventListener('click', (e) => {
    const switcher = document.getElementById('lang-switcher');
    if (!switcher?.contains(e.target as Node)) {
      dropdown?.classList.add('hidden');
    }
  });
</script>

